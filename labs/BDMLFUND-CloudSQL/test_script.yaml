name: 'Big Data & ML Fundamentals Lab 3 : Setup Rentals Data in Cloud SQL v1.3 - Test'
description: "The script downloads the code from the git.\nCreates database tables by importing .sql files from Cloud Storage into the Cloud SQL instance.\nPopulates the tables by importing .csv files from Cloud Storage.\n Allows access to Cloud SQL."
deployment_manager_time: 300
run_regularly: true
failure_alerts_only: true
subscribers:
 - training-qa-testers@google.com
 - ajaych@google.com
steps:
 - command: |
     sudo apt-get update
     sudo apt-get -y -qq install git
     # Task 1: Download the code from github
     git clone https://github.com/GoogleCloudPlatform/training-data-analyst
     cd training-data-analyst/CPB100/lab3a
 - command: |
     # Task 2: Create the Cloud Storage bucket
     gsutil mb -l us-central1 gs://$PROJECT/
 - command: |
     # Task 3: Stage .sql and .csv files into Cloud Storage
     gsutil cp cloudsql/* gs://$PROJECT/sql/
 - command: |
     # Task 4: Create Cloud SQL instance
     gcloud sql instances create rentals --authorized-networks=$(bash ./find_my_ip.sh) --gce-zone us-central1-a
     gcloud sql users set-password root --host=% --instance=rentals --password=root
     cd
 - command: |
     # Task 5: Give permission to the Bucket and its data
     INSTANCE_SA=$(gcloud sql instances describe rentals --format='value(serviceAccountEmailAddress)')
     gsutil acl ch -u $INSTANCE_SA:W gs://$PROJECT
     gsutil acl ch -u $INSTANCE_SA:R gs://$PROJECT/sql/*
     # Import tables in SQL instance
     gcloud sql import sql rentals gs://$PROJECT/sql/table_creation.sql --quiet
 - command: |
     # Populate tables in SQL instance
     gcloud sql import csv rentals gs://$PROJECT/sql/accommodation.csv --database=recommendation_spark --table=Accommodation --quiet
     gcloud sql import csv rentals gs://$PROJECT/sql/rating.csv --database=recommendation_spark --table=Rating --quiet
