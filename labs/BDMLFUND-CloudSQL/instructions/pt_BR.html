<h1>Configuração de dados de aluguéis no Cloud SQL</h1>
<h2>Visão geral</h2>
<p>Neste laboratório, você preencherá dados de aluguéis no Cloud SQL para uso pelo mecanismo de recomendação de aluguéis.</p>
<h3><strong>Conteúdo do laboratório</strong></h3>
<p>Neste laboratório, você aprenderá a:</p>
<ul>
<li>
<p>criar instância do Cloud SQL;</p>
</li>
<li>
<p>criar tabelas de bancos de dados por meio da importação de arquivos .sql do Cloud Storage;</p>
</li>
<li>
<p>preencher as tabelas por meio da importação de arquivos .csv do Cloud Storage;</p>
</li>
<li>
<p>conceder acesso ao Cloud SQL;</p>
</li>
<li>
<p>explorar os dados de aluguéis por meio do uso de instruções SQL do Cloud Shell.</p>
</li>
</ul>
<h2>Introdução</h2>
<p>Neste laboratório, você preencherá dados de aluguéis no Cloud SQL para uso pelo mecanismo de recomendação de aluguéis. O mecanismo de recomendações será executado no Dataproc com uso do Spark ML, e você fará essa configuração no próximo laboratório.</p>
<fragment path="/fragments/startqwiklab"></fragment>
<h2>Configuração</h2>
<fragment path="/fragments/cloudshell"></fragment>
<h2>Tarefa 1: acesse o código do laboratório</h2>
<p>Para explorar o código do laboratório no Cloud Shell, faça o seguinte:</p>
<ol>
<li>
<p>No Cloud Shell, digite:</p>
<pre><code class="language-bash">git clone https://github.com/GoogleCloudPlatform/training-data-analyst
</code></pre>
<p>Essa operação faz o download do código do GitHub.</p>
</li>
<li>
<p>Navegue até a pasta correspondente deste laboratório:</p>
<pre><code class="language-bash">cd training-data-analyst/CPB100/lab3a
</code></pre>
</li>
<li>
<p>Analise o arquivo de criação da tabela usando o comando <strong>less</strong>:</p>
<pre><code class="language-bash">less cloudsql/table_creation.sql
</code></pre>
<p>Com o comando <strong>less</strong> você pode ver o arquivo. Pressione a <strong>barra de espaço</strong> para rolar para baixo, a letra <strong>b</strong> para voltar uma página ou a letra <strong>q</strong> para sair.</p>
</li>
<li>
<p>Preencha estas informações (a primeira linha já foi preenchida para você):</p>
<table>
<thead>
<tr>
<th align="left">Nome da tabela</th>
<th align="left">Colunas</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Acomodação</td>
<td align="left">Código, título, local, preço, quartos, classificação, tipo</td>
</tr>
<tr>
<td align="left">________________?</td>
<td align="left">________________?</td>
</tr>
<tr>
<td align="left">________________?</td>
<td align="left">________________?</td>
</tr>
</tbody>
</table>
<p>Como elas estão relacionadas ao cenário de recomendação de aluguéis? Preencha as lacunas a seguir:</p>
<ul>
<li>Quando um usuário classifica uma casa marcando quatro estrelas, por exemplo, uma entrada é adicionada à tabela _________________________.</li>
<li>Informações gerais sobre casas, como número de quartos e classificação média, são armazenadas na tabela ________________.</li>
<li>O objetivo do mecanismo de recomendação é preencher a tabela __________________________ para cada usuário e casa, ou seja, essa é a classificação prevista de uma casa específica, feita por um determinado usuário.</li>
</ul>
</li>
<li>
<p>Analise os arquivos de dados usando o comando <strong>head</strong>:</p>
<pre><code class="language-bash">head cloudsql/*.csv
</code></pre>
<p>O comando <strong>head</strong> mostra as primeiras linhas de cada arquivo.</p>
</li>
</ol>
<h2>Tarefa 2: crie um intervalo</h2>
<ol>
<li>
<p>No Console do GCP, no <strong>menu de navegação</strong> (<img alt="8ab244f9cffa6198.png" src="img/mainmenu.png">).</p>
</li>
<li>
<p>Clique em <strong>Storage</strong>.</p>
</li>
<li>
<p>Clique em <strong>Criar Intervalo</strong>.</p>
</li>
<li>
<p>Em <strong>Name</strong>, digite o <strong>código do projeto</strong>. Selecione <strong>Definir permissões no nível do objeto e no nível do intervalo</strong> sob <strong>Modelo de controle de acesso</strong>, depois clique em <strong>Criar</strong>. Para encontrar o <strong>código do projeto</strong>, clique no projeto no menu superior do Console do GCP e copie o valor em <strong>ID</strong> do projeto selecionado.</p>
<p>Anote o nome do seu intervalo. No restante do laboratório, substitua <code>&lt;BUCKET-NAME&gt;</code> pelo nome exclusivo do seu intervalo.</p>
</li>
</ol>
<h2>Tarefa 3: organize os arquivos .sql e .csv no Cloud Storage</h2>
<p>Insira a definição da tabela e os arquivos de dados no Cloud Storage, para que depois você possa importá-los para o Cloud SQL:</p>
<ol>
<li>
<p>No diretório <strong>lab3a</strong> do Cloud Shell, digite:</p>
<pre><code class="language-bash">gsutil cp cloudsql/* gs://&lt;BUCKET-NAME&gt;/sql/
</code></pre>
<p>substituindo BUCKET-NAME pelo nome do intervalo.</p>
</li>
<li>
<p>No Console do GCP, navegue para <strong>Storage</strong>, acesse seu intervalo e verifique se os arquivos <code>.sql</code> e <code>.csv</code> estão presentes.</p>
</li>
</ol>
<h2>Tarefa 4: crie uma instância do Cloud SQL</h2>
<ol>
<li>
<p>No Console do GCP, clique em <strong>SQL</strong> (na seção "Storage").</p>
</li>
<li>
<p>Clique em <strong>Criar instância</strong>.</p>
</li>
<li>
<p><strong>Selecionar MySQL</Strong>. Clique em <Strong>Próxima</Strong> se necessário. Clique em <Strong>Configurar MySQL de desenvolvimento</Strong> ou <Strong>Escolher a Segunda geração</Strong>.</p>
</li>
<li>
<p>Em <strong>Código da instância</strong>, digite <strong>rentals</strong>.</p>
<p><img src="img/ab1cdf08212ecadf.png" alt="ab1cdf08212ecadf.png"></p>
</li>
<li>
<p>Role para baixo e especifique a senha raiz. Antes que você esqueça, anote a senha.</p>
</li>
<li>
<p>Clique em <strong>Criar</strong> para criar a instância. O provisionamento da instância do Cloud SQL levará cerca de um minuto.</p>
</li>
</ol>
<h2>Tarefa 5: crie as tabelas</h2>
<ol>
<li>
<p>No <strong>Cloud SQL</strong>, clique em <strong>rentals</strong> para visualizar as informações da instância.</p>
</li>
<li>
<p>Clique em <strong>Importar</strong> na barra do menu superior.</p>
</li>
<li>
<p>Clique em <strong>Parcurar</strong>. Uma lista de intervalos será exibida. Clique no intervalo criado, navegue para <strong>sql</strong> e clique em <strong>table_creation.sql</strong>.</p>
</li>
<li>
<p>Clique em <strong>Selecionar</strong> e em <strong>Importar</strong>.</p>
</li>
</ol>
    <aside class="warning"><p>
    <strong>Nota</strong>: Se importação de arquivos <code>.sql</code> or <code>.csv</code> falha na primeira tentativa, tente novamente.
    </p>
    </aside>
<h2>Tarefa 6: preencha as tabelas</h2>
<ol>
<li>
<p>Para importar arquivos CSV do Cloud Storage a partir da página do Console do GCP com os detalhes da instância do Cloud SQL, clique em <strong>Importar</strong> (menu superior).</p>
</li>
<li>
<p>Clique em <strong>Procurar</strong>, navegue no intervalo que você criou para <strong>sql</strong> e clique em <strong>accommodation.csv</strong>. Clique em <strong>Selecionar</strong>.</p>
</li>
<li>
<p>Em <strong>Banco de dados</strong>, selecione <strong>recommendation_spark</strong>.</p>
</li>
<li>
<p>Em <strong>Tabela</strong>, digite <strong>Accommodation</strong>.</p>
<p><img src="img/c899adb7fdb39f17.png" alt="c899adb7fdb39f17.png"></p>
</li>
<li>
<p>Clique em <strong>Importar</strong>.</p>
</li>
<li>
<p>Repita a <strong>importação</strong> (etapas 1 a 5) para <strong>rating.csv</strong>, mas digite <strong>Rating</strong> para <strong>Tabela</strong>.</p>
</li>
</ol>
<h2>Tarefa 7: explore o Cloud SQL</h2>
<ol>
<li>
<p>Para explorar o Cloud SQL, você pode usar a CLI mysql. No Cloud Shell, digite o seguinte:</p>
<pre><code class="language-bash">wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
chmod +x cloud_sql_proxy
</code></pre>
</li>
<li>
<p>No Console do GCP, procure o <strong>Nome da conexão da instânci</strong> na guia Visão geral e copie-o. No comando abaixo, substitua por este valor <INSTANCE_CONNECTION_NAME> e execute-o.</p>
<pre><code class="language-bash">./cloud_sql_proxy -instances=&lt;INSTANCE_CONNECTION_NAME&gt;=tcp:3306 &
</code></pre>
</li>
<li>
<p>Conecte-se à Cloud SQL instance usando o mysql:</p>
<pre><code class="language-bash">mysql -u root -p --host 127.0.0.1
</code></pre>
</li>
<li>
<p>O MySQL solicitará a senha raiz. Digite a senha quando solicitada.</p>
</li>
<li>
<p>No prompt do mysql do Cloud Shell, digite:</p>
<pre><code class="language-bash">use recommendation_spark;
</code></pre>
<p>Isso define o banco de dados na sessão do mysql.</p>
</li>
<li>
<p>Veja a lista de tabelas criadas. Isso será útil para evitar erros de ortografia na consulta da etapa 4.</p>
<pre><code class="language-bash">show tables;
</code></pre>
</li>
<li>
<p>Vamos verificar se os dados foram carregados.</p>
<pre><code>select * from Rating;
</code></pre>
<p>Exemplo de resultado:</p>
<pre><code>| 23     | 99     |      5 |
| 4      | 99     |      4 |
| 7      | 99     |      5 |
| 8      | 99     |      5 |
+--------+--------+--------+
1186 rows in set (0.03 sec)
</code></pre>
</li>
<li>
<p>Vamos conferir se há alguma oferta interessante disponível.</p>
<pre><code>select * from Accommodation where type = 'castle' and price &lt; 1500;
</code></pre>
<p>Todos os castelos baratos têm classificações ruins.</p>
</li>
<li>
<p>Para sair do prompt do mysql, digite <strong>exit</strong>.</p>
</li>
</ol>
<fragment path="/fragments/endqwiklab"></fragment>

<h5>Manual atualizado em 22 de Fevereiro de 2019</h5>
<h5>Laboratório testado em 22 de Fevereiro de 2019</h5>
©2018 Google LLC Todos os direitos reservados. Google e o logotipo Google são marcas registradas da Google LLC Todos os demais nomes de produtos e empresas podem ser
marcas registradas das respectivas empresas às quais estão associados.
