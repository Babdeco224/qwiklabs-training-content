<h1>Cloud SQL に賃貸物件データをセットアップする</h1>
<h2>概要</h2>
<p>このラボでは、レコメンデーション エンジンで使用される賃貸物件データを Cloud SQL に入力します。</p>
<h3><strong>学習内容</strong></h3>
<p>このラボの内容:</p>
<ul>
<li>
<p>Cloud SQL インスタンスを作成する</p>
</li>
<li>
<p>Cloud Storage から .sql ファイルをインポートしてデータベース テーブルを作成する</p>
</li>
<li>
<p>Cloud Storage から .csv ファイルをインポートしてテーブルにデータを入れる</p>
</li>
<li>
<p>Cloud SQL へのアクセスを許可する</p>
</li>
<li>
<p>Cloud Shell から SQL ステートメントを使用して賃貸物件データを詳しく確認する</p>
</li>
</ul>
<h2>はじめに</h2>
<p>このラボでは、レコメンデーション エンジンで使用される賃貸物件データを Cloud SQL に入力します。レコメンデーション エンジン自体は Dataproc で Spark ML を使用して実行します。これは、次のラボで設定します。</p>
<fragment path="/fragments/startqwiklab"></fragment>
<h2>設定</h2>
<fragment path="/fragments/cloudshell"></fragment>
<h2>タスク 1: ラボのコードにアクセスする</h2>
<p>Cloud Shell でラボのコードを詳しく見るには:</p>
<ol>
<li>
<p>Cloud Shell で次のように入力します。</p>
<pre><code class="language-bash">git clone https://github.com/GoogleCloudPlatform/training-data-analyst
</code></pre>
<p>これにより、github からコードがダウンロードされます。</p>
</li>
<li>
<p>このラボに対応するフォルダに移動します。</p>
<pre><code class="language-bash">cd training-data-analyst/CPB100/lab3a
</code></pre>
</li>
<li>
<p>次のように <strong>less</strong> を使用して、テーブル作成ファイルを確認します。</p>
<pre><code class="language-bash">less cloudsql/table_creation.sql
</code></pre>
<p>less コマンドを使用すると、ファイルを表示できます（<strong>スペースキー</strong>を押すと下へスクロール、<strong>b</strong> で 1 ページ戻り、<strong>q</strong> で終了します）。</p>
</li>
<li>
<p>次の情報を入力します（最初の行は自動的に入力されます）。</p>
<table>
<thead>
<tr>
<th align="left">表名</th>
<th align="left">列</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Accommodation（宿泊施設）</td>
<td align="left">id、title（タイトル）、location（場所）、price（価格）、rooms（部屋）、rating（評価）、type（タイプ）</td>
</tr>
<tr>
<td align="left">________________?</td>
<td align="left">________________?</td>
</tr>
<tr>
<td align="left">________________?</td>
<td align="left">________________?</td>
</tr>
</tbody>
</table>
<p>これらは rentals レコメンデーション シナリオとどのように関連していますか。以下の空欄に記入してください。</p>
<ul>
<li>ユーザーが住宅物件の評価（たとえば 4 つ星）を入力すると、入力内容が ________________ テーブルに追加されます。</li>
<li>住宅物件についての一般情報（部屋の数、評価の平均値など）は ________________ テーブルに格納されます。</li>
<li>レコメンデーション エンジンは、それぞれのユーザーと住宅物件に関する ________________ テーブルに挿入します。これは、そのユーザーによるその住宅物件の評価予測です。</li>
</ul>
</li>
<li>
<p>次のように <strong>head</strong> を使用して、データファイルを確認します。</p>
<pre><code class="language-bash">head cloudsql/*.csv
</code></pre>
<p><strong>head</strong> コマンドにより、各ファイルの最初の数行が表示されます。</p>
</li>
</ol>
<h2>タスク 2: バケットを作成する</h2>
<ol>
<li>
<p>GCP Console の[ナビゲーション メニュー]（<img alt="8ab244f9cffa6198.png" src="img/mainmenu.png">）に移動します。</p>
</li>
<li>
<p>[Storage] をクリックします。</p>
</li>
<li>
<p>[バケットを作成] をクリックします。</p>
</li>
<li>
<p>[名前] にプロジェクト ID を入力し。[アクセス制御モデル] の下にある [オブジェクト レベルとバケットレベルの権限を設定] を選択し、[作成]をクリックします。[プロジェクト ID] を探すには、GCP Console のトップメニューでプロジェクトをクリックし、選択したプロジェクトの ID の値をコピーします。</p>
<p>使用するバケットの名前をメモしておきます。このラボでは、これ以降 <code>&lt;BUCKET-NAME&gt;</code> を一意のバケット名に置き換えてください。</p>
</li>
</ol>
<h2>タスク 3: .sql と .csv ファイルを Cloud Storage にステージングする</h2>
<p>後で Cloud SQL にインポートできるよう、テーブル定義とデータファイルを Cloud Storage にステージングします。</p>
<ol>
<li>
<p>Cloud Shell で <strong>lab3a</strong> ディレクトリから次のように入力します。</p>
<pre><code class="language-bash">gsutil cp cloudsql/* gs://&lt;BUCKET-NAME&gt;/sql/
</code></pre>
<p>実際のバケットの名前に置き換えてください。</p>
</li>
<li>
<p>GCP Console から [Storage] に移動してバケットを確認し、<code>.sql</code> ファイルと <code>.csv</code> ファイルが存在すること確認します。</p>
</li>
</ol>
<h2>タスク 4: Cloud SQL インスタンスを作成する</h2>
<ol>
<li>
<p>GCP Console で [ストレージ] セクションの [SQL] を選択します。</p>
</li>
<li>
<p>[インスタンスを作成] をクリックします。</p>
</li>
<li>
<p>[MySQL] を選択します。もし必要なら、[次へ]をクリックします。[MySQL Development を構成] をクリックします　又は [第 2 世代を選択]を選択します。</p>
</li>
<li>
<p>[インスタンス ID] に「rentals」と入力します。</p>
<p><img src="img/ab1cdf08212ecadf.png" alt="ab1cdf08212ecadf.png"></p>
</li>
<li>
<p>スクロールダウンして、ルートパスワードを指定します。忘れる前に、rootのパスワードを書き留めておいてください。</p>
</li>
<li>
<p>[作成] をクリックしてインスタンスを作成します。約 1 分で Cloud SQL インスタンスがプロビジョニングされます。</p>
</li>
</ol>
<h2>タスク 5: テーブルを作成する</h2>
<ol>
<li>
<p>Cloud SQL で [rentals] をクリックし、インスタンス情報を表示します。</p>
</li>
<li>
<p>上部のメニューバーにある [インポート] をクリックします。</p>
</li>
<li>
<p>[参照] をクリックします。バケットのリストが表示されます。作成したバケットをクリックして「sql」に移動し、[table_creation.sql] をクリックします。</p>
</li>
<li>
<p>[選択] &gt; [インポート] をクリックします。</p>
</li>
</ol>
    <aside class="warning"><p>
    <strong>注意</strong>: <code>.sql</code> 又は <code>.csv</code> ファイルをインポートするのに初回に失敗する場合は、再びお試しください。
    </p>
    </aside>
<h2>タスク 6: テーブルにデータを入れる</h2>
<ol>
<li>
<p>Cloud Storage から CSV ファイルをインポートするには、GCP Console の Cloud SQL インスタンスの詳細ページで、[インポート]（トップメニュー）をクリックします。</p>
</li>
<li>
<p>[参照] をクリックして、作成したバケットから [sql] を参照し、[accommodation.csv] &gt; [選択] をクリックします。</p>
</li>
<li>
<p>[データベース] で [recommendation_spark] を選択します。</p>
</li>
<li>
<p>[テーブル] に「Accommodation」と入力します。</p>
<p><img src="img/c899adb7fdb39f17.png" alt="c899adb7fdb39f17.png"></p>
</li>
<li>
<p>[インポート] をクリックします。</p>
</li>
<li>
<p>[rating.csv] を対象に [インポート]（ステップ 1～5）をもう一度行います。ただし、[テーブル] には「Rating」と入力します。</p>
</li>
</ol>
<h2>タスク 7: Cloud SQL について詳しく確認する</h2>
<ol>
<li>
<p>Cloud SQL について詳しく確認するには mysql CLI を利用します。Cloud Shell で以下のように入力します:</p>
<pre><code class="language-bash">wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
chmod +x cloud_sql_proxy
</code></pre>
</li>
<li>
<p>GCPコンソールで、[概要]タブで [インスタンス接続名] 名前を見つけてコピーします。次のコマンドで、<INSTANCE_CONNECTION_NAME>をこの値に置き換えて実行します。</p>
<pre><code class="language-bash">./cloud_sql_proxy -instances=&lt;INSTANCE_CONNECTION_NAME&gt;=tcp:3306 &
</code></pre>
</li>
<li>
<p>mysqlを使用してCloud SQLインスタンスに接続します。</p>
<pre><code class="language-bash">mysql -u root -p --host 127.0.0.1
</code></pre>
</li>
<li>
<p>root パスワードの入力を求めるプロンプトが MySQL によって表示されます。プロンプトが表示されたら、パスワードを入力します。</p>
</li>
<li>
<p>Cloud Shell の mysql プロンプトで、次のように入力します。</p>
<pre><code class="language-bash">use recommendation_spark;
</code></pre>
<p>これで mysql セッションにデータベースが設定されます。</p>
</li>
<li>
<p>作成したテーブルのリストを表示します。これはステップ 4 でのクエリの入力ミスを防ぐために役立ちます。</p>
<pre><code class="language-bash">show tables;
</code></pre>
</li>
<li>
<p>データが読み込まれたことを確認します。</p>
<pre><code>select * from Rating;
</code></pre>
<p>出力例:</p>
<pre><code>| 23     | 99     |      5 |
| 4      | 99     |      4 |
| 7      | 99     |      5 |
| 8      | 99     |      5 |
+--------+--------+--------+
1186 rows in set (0.03 sec)
</code></pre>
</li>
<li>
<p>お得な物件があるかどうか確認します。</p>
<pre><code>select * from Accommodation where type = 'castle' and price &lt; 1500;
</code></pre>
<p>低価格の「castle」物件の評価はすべて低くなっています。</p>
</li>
<li>
<p>「exit」と入力すると mysql プロンプトを終了できます。</p>
</li>
</ol>
<fragment path="/fragments/endqwiklab"></fragment>
<h5>マニュアルの最終更新日: 2019 年 02 月 22 日</h5>
<h5>ラボの最終テスト日: 2019 年 02 月 22 日</h5>
<fragment path="/fragments/copyright"></fragment>
