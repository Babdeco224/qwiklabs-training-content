---
:name: 'GCP Fundamentals: Getting Started with Cloud Storage and Cloud SQL'
:description: "1. Deploy a web server VM instance.\r\n2. Create a Cloud Storage bucket
  using the gsutil command line.\r\n3. Create the Cloud SQL instance."
:pass_percent: !ruby/object:BigDecimal 18:0.75e2
:notify: false
:score_completion_only: false
:steps:
- :title: Deploy a web server VM instance
  :points: 5
  :max: 50
  :interval: 30
  :multi_region: false
  :api: GCP
  :services:
  - ComputeV1
  :method_name: step_one_check
  :code: "def step_one_check(handles, points)\r\n  compute = handles[:ComputeV1]\r\n
    \ ret_hash = { :done => false, :score => 0, :message => \"\" }\r\n  desired_instance
    = 'bloghost'\r\n  desired_key = 'startup-script'\r\n  desired_value = \"apt-get
    update\\napt-get install apache2 php php-mysql -y\\nservice apache2 restart\"\r\n
    \ desired_disk = 'licenses/debian-9-stretch'\r\n  \r\n  instances = compute.list_instances
    &. items || []\r\n  instances.each do |instance|\r\n    if instance.name == desired_instance\r\n
    \     instance.metadata.items.each do |item|\r\n        if item.key == desired_key
    && item.value == desired_value\r\n          ret_hash[:score] += 2\r\n        end\r\n
    \     end\r\n      instance.disks.each do |disk|\r\n        disk.licenses.each
    do |license|\r\n          if license.include?(desired_disk)\r\n            ret_hash[:score]
    += 3 \r\n          end\r\n        end\r\n      end\r\n    end\r\n  end\r\n  if
    ret_hash[:score] == points\r\n    ret_hash = { :done => true, :score => points,
    :message => \"Success: Deploy a web server VM instance\" }  \r\n  end\r\nreturn
    ret_hash\r\nend"
- :title: Create a Cloud Storage bucket using the gsutil command line
  :points: 5
  :max: 50
  :interval: 30
  :multi_region: false
  :api: GCP
  :services:
  - StorageV1
  :method_name: step_two_check
  :code: "def step_two_check(handles, points)\r\n  storage = handles[:StorageV1]\r\n
    \ ret_hash = { :done => false, :score => 0, :message => \"\" }\r\n  desired_file
    = 'my-excellent-blog.png'\r\n  desired_property = 'allUsers'\r\n  buckets = storage.list_buckets
    &. items || []\r\n  buckets.each do |bucket|\r\n    if bucket.name == storage.project\r\n
    \     objects = storage.list_objects(bucket.name) &. items || []\r\n      objects.each
    do |object|\r\n       if object.name == desired_file && object.id.include?(desired_file)\r\n
    \         acl = storage.list_object_access_controls(bucket.name, object.name)
    &. items || []\r\n          acl.each do |property|\r\n            if property.entity
    == desired_property\r\n              ret_hash = { :done => true, :score => points,
    :message => \"Success: Create a Cloud Storage bucket using the gsutil command
    line\" }\r\n            end\r\n          end\r\n        end\r\n      end\r\n    end\r\n
    \ end\r\n  return ret_hash\r\nend\r\n\r\n\r\n"
- :title: Create the Cloud SQL instance
  :points: 5
  :max: 50
  :interval: 30
  :multi_region: false
  :api: GCP
  :services:
  - ComputeV1
  - SqladminV1beta4
  :method_name: step_three_check
  :code: "def step_three_check(handles, points)\r\n  sql = handles[:SqladminV1beta4]\r\n
    \ compute = handles[:ComputeV1]\r\n  ret_hash = { :done => false, :score => 0,
    :message => \"\" }\r\n  desired_instance = 'blog-db'\r\n  desired_operation_type
    = 'CREATE_USER'\r\n  desired_status = 'DONE'\r\n  auth_avail = false\r\n  user_avail
    = false\r\n  \r\n  instances = sql.list_instances &. items || []\r\n  instances.each
    do |instance|\r\n    if instance.name == desired_instance\r\n      instance.settings.ip_configuration.authorized_networks.each
    do |network|\r\n        ip_value = network.value\r\n        network_name = network.name\r\n
    \       vm_instances = compute.list_instances &. items || []\r\n        vm_instances.each
    do |vm_instance|\r\n          network_interface = vm_instance.network_interfaces\r\n
    \         nat_ip = network_interface[0].access_configs[0].nat_ip\r\n          desired_ip
    = nat_ip + '/32'\r\n          if ip_value == desired_ip\r\n            auth_avail
    = true\r\n          end\r\n        end\r\n      end\r\n      operations = sql.list_operations(instance.name)
    &. items || []\r\n      operations.each do |operation|\r\n        if operation.operation_type
    == desired_operation_type && operation.status == desired_status\r\n          if
    operation.target_id == instance.name\r\n            user_avail = true\r\n          end\r\n
    \       end \r\n      end\r\n    end\r\n  end\r\n  \r\n  if auth_avail && user_avail\r\n
    \   ret_hash = { :done => true, :score => points, :message => \"Success: Create
    the Cloud SQL instance\" }  \r\n  end\r\n  return ret_hash\r\nend"
