---
:name: 'GCP Fundamentals: Getting Started with Cloud Marketplace'
:description: 1. Use Cloud Marketplace to deploy a LAMP stack.
:pass_percent: !ruby/object:BigDecimal 18:0.75e2
:notify: false
:score_completion_only: false
:steps:
- :title: Use Cloud Marketplace to deploy a LAMP stack
  :points: 10
  :max: 25
  :interval: 10
  :multi_region: false
  :api: GCP
  :services:
  - DeploymentmanagerV2
  :method_name: step_one_check
  :code:  |-
    def step_one_check(handles, points)
      dm = handles[:DeploymentmanagerV2]
      ret_hash = { :done => false, :score => 0, :message => "" }
      desired_deployment_name = 'lampstack'
      resource_name_1 = 'vm'
      resource_name_2 = 'tcp-80'
      resource_name_3 = 'tcp-443'
      checker = 0

      deployments = dm.list_deployments&.deployments || []
        deployments.each do |deployment|
          if !deployment.operation.error
            if deployment.name.include?(desired_deployment_name)
              deployment_name = deployment.name
              resources = dm.list_resources(deployment_name)&. resources || []
              resources.each do |resource|
                if resource.name.include?(resource_name_1)
                  checker += 1
                end
                if resource.name.include?(resource_name_2)
                  checker += 1
                end
                if resource.name.include?(resource_name_3)
                  checker += 1
                end
              end
            end
          end
          if checker != 3
            checker = 0
          elsif checker == 3
            ret_hash = { :done => true, :score => points, :message => "Success: Use Cloud Marketplace to deploy a LAMP stack" }
            break
          end
        end
      return ret_hash
    end
