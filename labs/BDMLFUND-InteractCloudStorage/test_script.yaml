name: 'Big Data & ML Fundamentals Lab 2: Interact with Google Cloud Storage v1.3 - Test'
description: "The script creates a compute engine instance with necessary API access.\nInstalls software and Ingest USGS data.\nTransforms the data.\nCreates bucket and Store data.\nPublishes Cloud Storage files to web."
deployment_manager_time: 180
run_regularly: true
failure_alerts_only: true
subscribers:
 - training-qa-testers@google.com
 - ajaych@google.com
steps:
 - command: |
    #Task1: Create Compute Engine instance with the necessary API access
    gcloud compute instances create instance1 --zone us-central1-a --scopes https://www.googleapis.com/auth/cloud-platform
    # Task 5: Creation of bucket
    gsutil mb gs://$PROJECT/
 - command: |
    # Task 2: SSH into the instance
    gcloud compute config-ssh --quiet
    ssh instance1.us-central1-a.$PROJECT -o StrictHostKeyChecking=no <<EOF
    #Task3: Install software and Ingest USGS data
    sudo apt-get update
    sudo apt-get -y -qq install git
    # Download the code from github
    git clone https://github.com/GoogleCloudPlatform/training-data-analyst
    cd training-data-analyst/CPB100/lab2b
    #Download a dataset of earthquake
    bash ingest.sh
    #Task 4: Transform the data
    bash install_missing.sh
    python3 transform.py
    #Task 5: Create bucket
    gsutil cp earthquakes.* gs://$PROJECT/earthquakes/
    #Task 6: Publish Cloud Storage files to web
    gsutil acl ch -u AllUsers:R gs://$PROJECT/earthquakes/*
    EOF
